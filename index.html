<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Habit Tracker</title>
    <style>
        :root {
            --bg-empty: #ebedf0;
            --border-color: rgba(27, 31, 35, 0.06);
            /* Sequential Palettes */
            --exercise-1: #9be9ff; --exercise-2: #0070f3;
            --eating-1: #40c463;
            --steps-1: #ffb74d; --steps-2: #f57c00;
            --decompress-1: #b39ddb;
        }

        * { box-sizing: border-box; }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; padding: 20px; color: #24292e; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* Grid Styling */
        .grid-wrapper { overflow-x: auto; padding-bottom: 20px; position: relative; }
        .grid-header { position: relative; height: 20px; margin-left: 40px; margin-bottom: 5px; }
        .month-label { position: absolute; font-size: 12px; color: #586069; white-space: nowrap; top: 0; }

        .grid-body { display: flex; }
        .row-labels { 
            display: grid; 
            grid-template-rows: repeat(7, 12px); 
            grid-gap: 3px; 
            padding-right: 10px; 
            font-size: 12px; 
            color: #586069; 
            width: 40px; 
            flex-shrink: 0; 
        }
        .row-labels div { height: 12px; line-height: 12px; white-space: nowrap; }

        .contributions-grid { 
            display: grid; 
            grid-template-columns: repeat(53, 12px); 
            grid-template-rows: repeat(7, 12px); 
            grid-gap: 3px; 
            grid-auto-flow: column;
        }

        .day { 
            width: 12px; height: 12px; 
            background-color: var(--bg-empty); 
            border-radius: 2px;
            outline: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            overflow: hidden;
        }

        /* Quadrant Logic */
        .q { width: 100%; height: 100%; background: transparent; }
        .full-cell { grid-column: span 2; grid-row: span 2; }

        /* Form Styling */
        .controls { margin-top: 30px; padding: 20px; border: 1px solid #e1e4e8; border-radius: 6px; background: #f6f8fa; }
        .form-group { margin-bottom: 15px; }
        label { font-weight: 600; display: block; margin-bottom: 5px; font-size: 14px; }
        select { padding: 5px; border-radius: 4px; border: 1px solid #d1d5da; width: 100%; max-width: 200px; }
        button { background-color: #2ea44f; color: white; border: 1px solid rgba(27, 31, 35, 0.15); padding: 6px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        button:hover { background-color: #2c974b; }

        /* Legend Styling */
        .legend { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px; 
            margin-top: 20px; 
            padding: 15px;
            background: #fff;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            font-size: 12px; 
            color: #586069; 
        }
        .legend-column { display: flex; flex-direction: column; gap: 8px; }
        .legend-column strong { color: #24292e; margin-bottom: 2px; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color { width: 12px; height: 12px; border-radius: 2px; outline: 1px solid var(--border-color); flex-shrink: 0; }
    </style>
</head>
<body>

<div class="container">
    <h2>Annual Habit Tracker</h2>
    
    <div class="grid-wrapper">
        <div class="grid-header" id="month-labels"></div>
        <div class="grid-body">
            <div class="row-labels">
                <div>Mon</div><div></div><div>Wed</div><div></div><div>Fri</div><div></div><div></div>
            </div>
            <div class="contributions-grid" id="main-grid"></div>
        </div>
    </div>

    <div class="legend">
        <div class="legend-column">
            <strong>Exercise</strong>
            <div class="legend-item"><div class="legend-color" style="background: var(--bg-empty)"></div> <span>None</span></div>
            <div class="legend-item"><div class="legend-color" style="background: var(--exercise-1)"></div> <span>Some (<1h)</span></div>
            <div class="legend-item"><div class="legend-color" style="background: var(--exercise-2)"></div> <span>Quite</span></div>
        </div>
        <div class="legend-column">
            <strong>Healthy Eating</strong>
            <div class="legend-item"><div class="legend-color" style="background: var(--bg-empty)"></div> <span>No</span></div>
            <div class="legend-item"><div class="legend-color" style="background: var(--eating-1)"></div> <span>Yes</span></div>
        </div>
        <div class="legend-column">
            <strong>10K Steps</strong>
            <div class="legend-item"><div class="legend-color" style="background: var(--bg-empty)"></div> <span>Barely moved</span></div>
            <div class="legend-item"><div class="legend-color" style="background: var(--steps-1)"></div> <span>Halfway</span></div>
            <div class="legend-item"><div class="legend-color" style="background: var(--steps-2)"></div> <span>Achieved</span></div>
        </div>
        <div class="legend-column">
            <strong>Decompress</strong>
            <div class="legend-item"><div class="legend-color" style="background: var(--bg-empty)"></div> <span>Mizeria</span></div>
            <div class="legend-item"><div class="legend-color" style="background: var(--decompress-1)"></div> <span>Found time</span></div>
        </div>
    </div>

    <div class="controls">
        <div class="form-group">
            <label for="date-select">Select Date:</label>
            <select id="date-select"></select>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label>Exercise</label>
                <select id="attr-exercise">
                    <option value="0">None</option>
                    <option value="1">Some (<1h)</option>
                    <option value="2">Quite</option>
                </select>
            </div>
            <div class="form-group">
                <label>Healthy Eating</label>
                <select id="attr-eating">
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
            <div class="form-group">
                <label>10K Steps</label>
                <select id="attr-steps">
                    <option value="0">Barely moved</option>
                    <option value="1">Halfway</option>
                    <option value="2">Achieved</option>
                </select>
            </div>
            <div class="form-group">
                <label>Decompress</label>
                <select id="attr-decompress">
                    <option value="0">Mizeria</option>
                    <option value="1">Found time</option>
                </select>
            </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
            <button onclick="saveData()">Update Grid</button>
            <button onclick="downloadJSON()" style="background-color: #24292e;">Download JSON</button>
            <button onclick="saveToGitHub()" style="background-color: #0366d6;">Save to GitHub</button>
        </div>
    </div>
</div>

<script>
    const grid = document.getElementById('main-grid');
    const monthHeader = document.getElementById('month-labels');
    const dateSelect = document.getElementById('date-select');
    let habitData = JSON.parse(localStorage.getItem('habitTrackerData')) || {};

    const colors = {
        exercise: [null, 'var(--exercise-1)', 'var(--exercise-2)'],
        eating: [null, 'var(--eating-1)'],
        steps: [null, 'var(--steps-1)', 'var(--steps-2)'],
        decompress: [null, 'var(--decompress-1)']
    };

    // Initialize Grid & Dates
    async function init() {
        const now = new Date();
        const year = now.getFullYear();
        const startOfYear = new Date(year, 0, 1);
        const startDayOfWeek = (startOfYear.getDay() + 6) % 7; // 0=Mon, 1=Tue, 2=Wed, 3=Thu, 4=Fri, 5=Sat, 6=Sun
        
        // Try to load data from data.json (GitHub Pages)
        try {
            const response = await fetch('data.json');
            if (response.ok) {
                const remoteData = await response.json();
                habitData = { ...remoteData, ...habitData }; // Merge remote with local
            }
        } catch (e) {
            console.log("No remote data.json found or error fetching it.");
        }

        // Setup Date Picker (Last 4 days, same year only)
        dateSelect.innerHTML = '';
        for(let i = 0; i < 4; i++) {
            const d = new Date(now);
            d.setDate(now.getDate() - i);
            
            // Only include if it's the same year
            if (d.getFullYear() === year) {
                const opt = document.createElement('option');
                opt.value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                opt.textContent = d.toDateString();
                dateSelect.appendChild(opt);
            }
        }

        // Clear grid
        grid.innerHTML = '';

        // Add empty cells for the first week offset
        for(let i = 0; i < startDayOfWeek; i++) {
            const empty = document.createElement('div');
            grid.appendChild(empty);
        }

        // Generate cells for each day of the year
        const isLeap = (year % 4 === 0 && (year % 100 !== 0 || year % 400 === 0));
        const daysInYear = isLeap ? 366 : 365;

        for(let i = 0; i < daysInYear; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'day';
            dayDiv.id = `day-${i}`;
            grid.appendChild(dayDiv);
        }

        // Generate Month Labels
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        monthHeader.innerHTML = '';
        let lastMonth = -1;
        for(let i = 0; i < daysInYear; i++) {
            const d = new Date(year, 0, i + 1);
            const m = d.getMonth();
            if(m !== lastMonth) {
                const colIndex = Math.floor((i + startDayOfWeek) / 7);
                const span = document.createElement('div');
                span.className = 'month-label';
                // Each column is 12px + 3px gap = 15px
                span.style.left = `${colIndex * 15}px`;
                span.textContent = months[m];
                monthHeader.appendChild(span);
                lastMonth = m;
            }
        }

        // Load existing data into grid
        Object.keys(habitData).forEach(dateKey => {
            updateCell(dateKey);
        });
    }

    function saveData() {
        const dateKey = dateSelect.value;
        const vals = {
            ex: parseInt(document.getElementById('attr-exercise').value),
            ea: parseInt(document.getElementById('attr-eating').value),
            st: parseInt(document.getElementById('attr-steps').value),
            de: parseInt(document.getElementById('attr-decompress').value)
        };
        
        habitData[dateKey] = vals;
        localStorage.setItem('habitTrackerData', JSON.stringify(habitData));
        updateCell(dateKey);
    }

    function downloadJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(habitData, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "habit_tracker_data.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    async function saveToGitHub() {
        const token = prompt("Enter your GitHub Personal Access Token (PAT):");
        if (!token) return;

        const repoPath = prompt("Enter your GitHub 'username/repo-name':");
        if (!repoPath) return;

        const fileName = "data.json";
        const url = `https://api.github.com/repos/${repoPath}/contents/${fileName}`;

        try {
            // 1. Try to get the current file SHA (if it exists)
            let sha = "";
            const getRes = await fetch(url, {
                headers: { "Authorization": `token ${token}` }
            });
            
            if (getRes.ok) {
                const fileData = await getRes.json();
                sha = fileData.sha;
            }

            // 2. Prepare the commit
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(habitData, null, 2))));
            const body = {
                message: "Update habit tracker data",
                content: content,
                sha: sha || undefined
            };

            // 3. Push to GitHub
            const putRes = await fetch(url, {
                method: "PUT",
                headers: {
                    "Authorization": `token ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(body)
            });

            if (putRes.ok) {
                alert("Successfully saved to GitHub! It may take a minute for the page to update.");
            } else {
                const err = await putRes.json();
                alert("Error saving to GitHub: " + err.message);
            }
        } catch (e) {
            alert("An error occurred: " + e.message);
        }
    }

    function updateCell(dateKey) {
        const [y, m, d] = dateKey.split('-').map(Number);
        const dateObj = new Date(y, m - 1, d);
        const start = new Date(y, 0, 1);
        const diff = Math.round((dateObj - start) / (1000 * 60 * 60 * 24));
        const cell = document.getElementById(`day-${diff}`);
        if(!cell) return;

        const data = habitData[dateKey];
        const activeCount = [data.ex, data.ea, data.st, data.de].filter(v => v > 0).length;

        cell.innerHTML = ''; // Clear previous

        if (activeCount === 1) {
            // Full color fill
            if(data.ex > 0) cell.style.backgroundColor = colors.exercise[data.ex];
            if(data.ea > 0) cell.style.backgroundColor = colors.eating[data.ea];
            if(data.st > 0) cell.style.backgroundColor = colors.steps[data.st];
            if(data.de > 0) cell.style.backgroundColor = colors.decompress[data.de];
            cell.style.display = 'block';
        } else if (activeCount > 1) {
            // Split into 4 quadrants
            cell.style.display = 'grid';
            cell.style.backgroundColor = 'transparent';
            
            const createQuad = (val, palette) => {
                const q = document.createElement('div');
                q.className = 'q';
                q.style.backgroundColor = val > 0 ? palette[val] : 'var(--bg-empty)';
                return q;
            };

            cell.appendChild(createQuad(data.ex, colors.exercise));
            cell.appendChild(createQuad(data.ea, colors.eating));
            cell.appendChild(createQuad(data.st, colors.steps));
            cell.appendChild(createQuad(data.de, colors.decompress));
        }
    }

    init();
</script>
</body>
</html>
